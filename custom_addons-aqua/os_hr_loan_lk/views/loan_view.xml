<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Top menu loan -->
        <menuitem
            id="menu_hr_loan" name="Loans" sequence="88"
            web_icon="os_hr_loan_lk,static/description/icon.png"/>

        <menuitem id="menu_config_loan" name="Configuration" parent="menu_hr_loan"
            sequence="5"/>
            
        <!-- Loan Configuration View -->    
        <record id="loan_type_form_view" model="ir.ui.view">
	        <field name="name">loan.type.form</field>
	     	<field name="model">loan.type</field>
	     	<field name="arch" type="xml">
	     		<form string='Employee Loans'>
	     			<group>
	     				<field name='code'/>
	     				<field name='name'/>
	     			</group>
	     		</form>
	     	</field>
        </record>
        
        <record id="loan_type_tree_view" model="ir.ui.view">
	        <field name="name">loan.type.tree</field>
	     	<field name="model">loan.type</field>
	     	<field name="arch" type="xml">
	     		<tree string='Employee Loans'>
	     				<field name='code'/>
	     				<field name='name'/>
	     		</tree>
	     	</field>
        </record>
        
        <record id="loan_type_view_filter" model="ir.ui.view">
	        <field name="name">loan.type.filter</field>
	     	<field name="model">loan.type</field>
	     	<field name="arch" type="xml">
	     		<search string='Loan Code'>
	     			<field name='code'/>
	     		</search>
	     	</field>
        </record>
        
        <record id="act_employee_loan_5_hr_contract" model="ir.actions.act_window">
            <field name="name">Contracts</field>
            <field name="res_model">hr.contract</field>
            <field name="view_type">form</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{
            	'search_default_employee_id': [employee_id],
                'default_employee_id': employee_id,
                'search_default_group_by_state': 1
            }</field>
        </record>
        
         <record id="act_employee_loan_5_hr_employee" model="ir.actions.act_window">
            <field name="name">Witness Employees</field>
            <field name="res_model">hr.employee</field>
            <field name="view_type">form</field>
            <field name="view_mode">kanban,tree,form</field>
        </record>
        
        <!-- Loan Details View -->    
        <record id="employee_loan_details_form_view" model="ir.ui.view">
	        <field name="name">employee.loan.details.form</field>
	     	<field name="model">loan.details</field>
	     	<field name="arch" type="xml">
	     		<form string='Employee Loans'>
	     			<header>
                		<button string="Submit" class="btn btn-primary" states="draft" name="submit_loan" type='object'></button>
                		<button string="Approve" class="btn btn-primary" states="awaiting" name="approve_loan" type='object' groups='hr.group_hr_manager'></button>
                		<button string="Reset to Draft" class="btn btn-primary" states="awaiting" name="reset_to_draft" type='object'></button>
                		<button string="Cancel" states="draft,awaiting" name="cancel_loan"  type='object'></button>
 	                 	<button string="Close" invisible="1"  name="close_loan" type='object'></button>
 	                 	<field name="state" widget="statusbar"/>
                	</header>
                	<sheet>
	                	<div class="oe_button_box" name="button_box">
	                        <button name="action_view_loans" type="object" class="oe_stat_button" icon="fa-handshake-o">
	                           	<field name="active_loans" widget="statinfo" />/
	                            <field name="total_loans" widget="statinfo" />
	                        </button>
	                        <button name="action_view_loans" type="object" class="oe_stat_button" icon="fa-money">
	                            <field name="active_loan_amount" widget="statinfo" />/
	                            <field name="total_loan_amount" widget="statinfo" />
	                        </button>
	                       <button name="%(act_employee_loan_5_hr_contract)d" class="oe_stat_button" icon="fa-book"
                            		type="action" groups="hr.group_hr_manager" context="{'employee_id': employee_id}">
                            		<field name="contracts_count" widget="statinfo"/>
                        	</button>
                        	<button name="action_view_witness" class="oe_stat_button" icon="fa-book"
                            		type="object" groups="hr.group_hr_manager">
                            		<field name="witness_count" widget="statinfo"/>
                        	</button>
	                    </div>
		     			<div class="oe_title">
	                        <h1>
	                            <field name="name" readonly="1"/>
	                        </h1>
	                    </div>
	                    <group colspan="4">
			     			<group>
			     				<field name='employee_id' attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
			     				<field name='employee_code' attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
			     				<field name='department_id' attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
			     				<field name='job_position_id' attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
			     			</group>
			     			<group>
			     				<field name='create_date'/>
			     				<field name='approved_by_id'/>
			     				<field name='approved_on'/>
			     				<field name='closed_on'/>
			     			</group>
			     		</group>
			     		<notebook>
				     		<page string="Loan Information">
	                            <group colspan="4">
	                                <group string="Loan" name="loan_primary">
	                                    <field name="loan_type_id" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                    <field name="loan_amount" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                    <field name="loan_date" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                </group>
	                                 <group name="loan_interest" string="Interest">
	                                    <field name="interest" widget="radio" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                    <field name="interest_rate" attrs="{'invisible':[('interest', '=', 'nointerest')],'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                </group>
	                                <group string="Installments" name="loan_install">
	                                    <field name="no_of_installments" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                    <field name="amount_per_install"/>
	                                    <field name="installment_start_date" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                </group>
	                                <group string="Payments" name="loan_payment">
	                                    <field name="amount_to_paid"/>
	                                    <field name="loan_payment" widget="many2onebutton" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                                    <field name="paid_amount"/>
	                                    <field name="balance_amount"/>
	                                </group>
	                            </group>
	                        </page>
	                        <page string="Witness" attrs="{'invisible': [('loan_payment','=','salary')]}">
	                        	<field name="witness_ids" nolabel="1" widget="one2many_list" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}">
	                        		<tree editable="top">
	                                    <field name="employee_id" />
	                                    <field name="repay" />
                                	</tree>
                                	<form>
			                        	<group colspan="4">
		                                   	<field name="employee_id"/>
		                                    <field name="repay" />
			                            </group>
			                        </form>
		                        </field>
	                        </page>
	                        <page string="Installments">
	                        	<field name="installment_ids" nolabel="1" attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}">
	                        		<tree editable="top">
	                        			<field name="ref_no" />
	                                    <field name="installment_date" />
	                                    <field name="amount"/>
	                                    <field name="paid_amount"/>
	                                    <field name="paid_date"/>
	                                    <field name="status" />
                                	</tree>
                                	<form>
			                        	<group colspan="4">
			                        		<field name="ref_no" />
		                                   	<field name="installment_date" />
		                                    <field name="amount"/>
		                                    <field name="paid_amount"/>
		                                    <field name="paid_date"/>
		                                    <field name="status" />
			                            </group>
			                        </form>
		                        </field>
	                        </page>
	                        <page string="Comments">
	                        	<field name="comments" nolabel='1' attrs="{'readonly': [('state','in',['approve','cancelled','closed'])]}"/>
	                        </page>
                    	</notebook>
		     		</sheet>
	     		</form>
	     	</field>
        </record>
        
        <!-- Loan Details View -->    
        <record id="employee_loan_details_tree_view" model="ir.ui.view">
	        <field name="name">employee.loan.details.tree</field>
	     	<field name="model">loan.details</field>
	     	<field name="arch" type="xml">
	     		<tree string='Employee Loans' decoration-muted="state=='cancelled'">
     				<field name='name'/>
     				<field name='employee_id'/>
     				<field name="amount_to_paid"/>
     				<field name='paid_amount'/>
     				<field name='balance_amount'/>
     				<field name='closed_on'/>
     				<field name="state"/>
	     		</tree>
	     	</field>
        </record>
        
        <record id="view_employee_loan_details_filter" model="ir.ui.view">
	        <field name="name">employee.loan.details.filter</field>
	        <field name="model">loan.details</field>
	        <field name="arch" type="xml">
	            <search string="Search Loans">
	                <filter string="Waiting Approval" domain="[('state','=','awaiting')]"/>
	                <filter string="Running" domain="[('state','=','approve')]"/>
	                <filter string="Closed" domain="[('state','=','closed')]"/>
	                <filter string="Cancelled" domain="[('state','=','cancelled')]"/>
	            </search>
	        </field>
    	</record>
        
       	<!--  Employee Inherit View Smart Button -->
		<record id="view_employee_inherit_form2" model="ir.ui.view">
	      <field name="name">hr.employee.inherit.form</field>
	      <field name="model">hr.employee</field>
	      <field name="inherit_id" ref="hr.view_employee_form"/>
	      <field name="arch" type="xml">
	      <data>
	       	<xpath expr="//div[@name='button_box']" position="inside">
               <button groups="os_hr_loan_lk.group_loan_employee" name="action_view_loans" type="object" class="oe_stat_button" icon="fa-handshake-o" attrs="{'invisible':[('total_loans', '==', 0)]}">
                   <field name='total_loans' widget="statinfo"/>/
                   <field name='total_loan_amount' widget="statinfo"/>
               </button>
	       	</xpath>
          </data>
          </field>
	    </record>
	    
        <!-- Salary Rule Inherit -->
        <record id="hr_salary_rule_form_inherit_loan" model="ir.ui.view">
	        <field name="name">hr.salary.rule.form.inherit.loan</field>
	        <field name="model">hr.salary.rule</field>
	        <field name="inherit_id" ref="hr_payroll.hr_salary_rule_form"/>
	        <field name="arch" type="xml">
	        	<data>
	        		<xpath expr="//field[@name='appears_on_payslip']" position="after">
						<field name ="loan_repayment"/>
					</xpath>
	        	</data>
	        </field>
        </record>
        
        <!-- Loan Installment  -->
        <record id="loan_installment_tree_view" model="ir.ui.view">
	        <field name="name">loan.installment.tree</field>
	     	<field name="model">loan.installment</field>
	     	<field name="arch" type="xml">
	     		<tree string='Loan Installments' decoration-muted="status=='paid'">
	     				<field name="ref_no" />
                        <field name="installment_date" />
                        <field name="amount" sum="Total" />
                        <field name="status" />
	     		</tree>
	     	</field>
        </record>
        
        <!-- Actions  -->
        <record id="open_config_view" model="ir.actions.act_window">
        	<field name="name">Loan Type</field>
	   	 	<field name="res_model">loan.type</field>
	   	 	<field name="view_type">form</field>
	   	 	<field name="view_mode">tree,form</field>
	   	 	<field name="help" type="html">
	   	 		<p class="oe_view_nocontent_create">
       				Click to create a Loan Type.
     			</p>
	   	 	</field>
	    </record>
	    
	    <record id="open_employee_loan_details" model="ir.actions.act_window">
        	<field name="name">Loans</field>
	   	 	<field name="res_model">loan.details</field>
	   	 	<field name="view_type">form</field>
	   	 	<field name="view_mode">tree,form</field>
	   	 	<field name="help" type="html">
	   	 		<p class="oe_view_nocontent_create">
       				Click to create a Loan.
     			</p>
	   	 	</field>
	    </record>
        
        <menuitem id="menu_loan_type" action="open_config_view" name="Loan Type" 
        parent="menu_config_loan" sequence="12"/>
        
        <menuitem id="main_menu_loan" action="open_employee_loan_details" name="Loan" 
        parent="menu_hr_loan" sequence="1"/>
        
 	</data>
 </odoo>